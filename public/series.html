<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Series - Violence Alley</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">
<style>
body {
  font-family: "Courier New", monospace;
  background: linear-gradient(135deg, #0b0b0b, #1a1a1a);
}
.neon-text {
  text-shadow: 0 0 5px #ff0000, 0 0 10px #ff0066, 0 0 20px #ff00cc;
}
.episode-card {
  transition: transform 0.2s, box-shadow 0.2s;
  background: #111;
}
.episode-card:hover {
  transform: scale(1.03);
  box-shadow: 0 0 20px #ff0044, 0 0 40px #ff00aa;
}
button {
  transition: background 0.2s;
}
/* FIX: Updated video player styling for iframe */
#video-player {
  width: 100%;
  max-width: 800px;
  margin: 20px auto;
  border: 4px solid #ff0055;
  border-radius: 8px;
}
</style>
</head>
<body class="text-red-500 p-6 min-h-screen">

<div id="content" class="max-w-5xl mx-auto">
  <p id="loading-indicator" class="text-center text-xl text-pink-500">Loading series details...</p>
</div>

<div id="video-player" class="hidden">
  <iframe id="player" src="" allowfullscreen class="w-full rounded" style="aspect-ratio: 16 / 9; border: none;"></iframe>
</div>

<footer class="text-center mt-12">
  <a href="index.html" class="text-cyan-400 underline">Back to Home</a>
</footer>

<script src="js/shows.js"></script>
<script>
const urlParams = new URLSearchParams(window.location.search);
const id = urlParams.get('id');
// FIX: Added parseInt() to ensure ID comparison is safe
const showInfo = showList.find(s => s.tmdb === parseInt(id)); 
const content = document.getElementById("content");
const videoPlayer = document.getElementById("video-player");
const loadingIndicator = document.getElementById("loading-indicator");
const iframePlayer = document.getElementById("player"); // Reference to the new iframe

// FIX: Moved fetchShow and fetchSeason to utility functions (or would be if centralized)
async function fetchShow(tmdbId) {
  const res = await fetch(`/api/tmdb?type=tv&id=${tmdbId}`);
  if (!res.ok) return null;
  return res.json();
}

async function fetchSeason(tmdbId, seasonNum) {
  const res = await fetch(`/api/tmdb?type=season&id=${tmdbId}&season=${seasonNum}`);
  if (!res.ok) return null;
  return res.json();
}

if (!showInfo) {
  content.innerHTML = "<p class='text-center text-red-500'>Show not found.</p>";
} else {

  (async () => {
    const showData = await fetchShow(id);

    // Remove loading indicator now that data has arrived
    if (loadingIndicator) loadingIndicator.remove(); 

    if (!showData || showData.success === false) {
        content.innerHTML = "<p class='text-center text-red-500'>Error loading series data.</p>";
        return;
    }

    content.innerHTML = `
      <header class="text-center mb-8">
        <h1 class="text-5xl font-bold mb-2 text-red-500 neon-text">${showData.name}</h1>
        <p class="text-cyan-400 max-w-3xl mx-auto">${showData.overview}</p>
      </header>
    `;

    const episodesContainer = document.createElement("div");
    episodesContainer.className = "space-y-6";
    content.appendChild(episodesContainer);
    
    // FIX: Filter out special season 0 and create promises for concurrent fetching
    const validSeasons = showData.seasons.filter(s => s.season_number >= 1);
    const seasonFetchPromises = validSeasons.map(season => fetchSeason(id, season.season_number));
    
    // FIX: PERFORMANCE IMPROVEMENT - Wait for all season data to load concurrently
    const allSeasonData = await Promise.all(seasonFetchPromises);

    // Process season data
    for (let i = 0; i < validSeasons.length; i++) {
      const season = validSeasons[i];
      const seasonData = allSeasonData[i];

      if (!seasonData || !seasonData.episodes || seasonData.episodes.length === 0) continue; // Skip if no episode data

      const seasonDiv = document.createElement("div");
      seasonDiv.className = "mb-8";
      seasonDiv.innerHTML = `<h2 class="text-3xl text-pink-500 mb-4">Season ${season.season_number}</h2>`;
      episodesContainer.appendChild(seasonDiv);

      const epGrid = document.createElement("div");
      epGrid.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6";
      seasonDiv.appendChild(epGrid);

      seasonData.episodes.forEach(ep => {
        const epCard = document.createElement("div");
        epCard.className = "episode-card p-3 rounded-lg border border-pink-600 hover:border-red-500";

        const epThumbnail = ep.still_path ? `https://image.tmdb.org/t/p/w300${ep.still_path}` : 'https://via.placeholder.com/300x170?text=No+Image';

        epCard.innerHTML = `
                    <img src="${epThumbnail}" alt="${ep.name}" class="w-full rounded mb-2" loading="lazy">
          <h3 class="text-xl font-bold text-red-500 mb-1">${ep.name}</h3>
          <p class="text-gray-300 text-sm mb-2">${ep.overview ? ep.overview.substring(0,120) + "..." : "No description available."}</p>
          <button class="bg-red-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded w-full">Watch</button>
        `;

        epCard.querySelector("button").addEventListener("click", () => {
          // Update player to show episode inline
          // Ensure 'showInfo.imdb' is present before using the URL
          if (!showInfo.imdb) {
              alert("Error: IMDB ID not configured for this show.");
              return;
          }
          const url = `https://vidfast.pro/tv/${showInfo.imdb}/${season.season_number}/${ep.episode_number}?autoPlay=true&autoNext=true`;
          
          // FIX: Set the iframe's src
          iframePlayer.src = url;
          videoPlayer.classList.remove("hidden");
          window.scrollTo({ top: videoPlayer.offsetTop - 20, behavior: "smooth" });
        });

        epGrid.appendChild(epCard);
      });
    }
  })();
}
</script>
</body>
</html>
