<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Series - Violence Alley</title>
<link href="css/style.css" rel="stylesheet">
</head>
<body>

<!-- Navigation -->
<nav class="navbar">
  <div class="navbar-container">
    <a href="index.html" class="navbar-logo">Violence Alley</a>
    <ul class="navbar-links" id="navbar-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="index.html#series">Series</a></li>
      <li><a href="request.html">Requests</a></li>
    </ul>
    <div class="navbar-actions">
      <a href="request.html" class="btn-primary">Submit Request</a>
    </div>
    <button class="mobile-menu-toggle" aria-controls="navbar-links" aria-expanded="false" aria-label="Toggle navigation">☰</button>
  </div>
</nav>

<!-- Content -->
<div class="container">
  <div id="content">
    <p id="loading-indicator" class="loading">Loading series details...</p>
  </div>
</div>

<!-- Video Player Overlay -->
<div id="video-player" class="video-player-overlay hidden">
  <div class="video-player-container">
    <button class="video-player-close" onclick="closePlayer()">✕ Close</button>
    <iframe 
      id="player" 
      class="video-player-iframe"
      src="" 
      allowfullscreen 
      allow="autoplay; fullscreen; picture-in-picture"
      sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-presentation"
    ></iframe>
  </div>
</div>

<!-- Footer -->
<footer class="footer">
  <div class="container">
    <p><a href="index.html">← Back to Home</a></p>
    <p class="footer-copyright">© 2025 Violence Alley</p>
  </div>
</footer>

<script>
// Mobile Menu Toggle with Accessibility
document.addEventListener('DOMContentLoaded', function() {
  const mobileToggle = document.querySelector('.mobile-menu-toggle');
  const navLinks = document.querySelector('.navbar-links');
  
  if (mobileToggle && navLinks) {
    mobileToggle.addEventListener('click', function() {
      const isExpanded = navLinks.classList.toggle('mobile-active');
      mobileToggle.setAttribute('aria-expanded', isExpanded);
    });
    
    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && navLinks.classList.contains('mobile-active')) {
        navLinks.classList.remove('mobile-active');
        mobileToggle.setAttribute('aria-expanded', 'false');
      }
    });
  }
});
</script>

<script src="js/shows.js"></script>
<script>
const urlParams = new URLSearchParams(window.location.search);
const id = urlParams.get('id');
const showInfo = showList.find(s => s.tmdb === parseInt(id));
const content = document.getElementById("content");
const videoPlayer = document.getElementById("video-player");
const loadingIndicator = document.getElementById("loading-indicator");
const iframePlayer = document.getElementById("player");

function closePlayer() {
  videoPlayer.classList.add("hidden");
  iframePlayer.src = "";
  document.body.style.overflow = "auto";
}

async function fetchShow(tmdbId) {
  const res = await fetch(`/api/tmdb?type=tv&id=${tmdbId}`);
  if (!res.ok) return null;
  return res.json();
}

async function fetchSeason(tmdbId, seasonNum) {
  const res = await fetch(`/api/tmdb?type=season&id=${tmdbId}&season=${seasonNum}`);
  if (!res.ok) return null;
  return res.json();
}

if (!showInfo) {
  content.innerHTML = "<p class='loading'>Show not found.</p>";
} else {
  (async () => {
    const showData = await fetchShow(id);

    if (loadingIndicator) loadingIndicator.remove();

    if (!showData || showData.success === false) {
      content.innerHTML = "<p class='loading'>Error loading series data.</p>";
      return;
    }

    content.innerHTML = `
      <section class="hero">
        <h1 class="hero-title">${showData.name}</h1>
        <p class="hero-subtitle">${showData.overview || "No description available."}</p>
      </section>
    `;

    const episodesContainer = document.createElement("div");
    content.appendChild(episodesContainer);
    
    const validSeasons = showData.seasons.filter(s => s.season_number >= 1);
    const seasonFetchPromises = validSeasons.map(season => fetchSeason(id, season.season_number));
    
    const allSeasonData = await Promise.all(seasonFetchPromises);

    for (let i = 0; i < validSeasons.length; i++) {
      const season = validSeasons[i];
      const seasonData = allSeasonData[i];

      if (!seasonData || !seasonData.episodes || seasonData.episodes.length === 0) continue;

      const seasonSection = document.createElement("section");
      seasonSection.className = "section";
      seasonSection.innerHTML = `<h2 class="section-title">Season ${season.season_number}</h2>`;
      
      const epGrid = document.createElement("div");
      epGrid.className = "grid";
      seasonSection.appendChild(epGrid);

      seasonData.episodes.forEach(ep => {
        const epCard = document.createElement("div");
        epCard.className = "card";

        const epThumbnail = ep.still_path 
          ? `https://image.tmdb.org/t/p/w500${ep.still_path}` 
          : 'https://via.placeholder.com/500x280?text=No+Image';

        epCard.innerHTML = `
          <div class="card-image-wrapper card-episode">
            <img src="${epThumbnail}" alt="${ep.name}" class="card-image" loading="lazy">
            <div class="card-badge">EP ${ep.episode_number}</div>
          </div>
          <div class="card-content">
            <h3 class="card-title">${ep.name}</h3>
            <p class="card-description">${ep.overview || "No description available."}</p>
            <button class="btn btn-primary" style="width: 100%; margin-top: 0.5rem;">▶ Watch Now</button>
          </div>
        `;

        epCard.querySelector("button").addEventListener("click", (e) => {
          e.preventDefault();
          if (!showInfo.imdb) {
            alert("Error: IMDB ID not configured for this show.");
            return;
          }
          const url = `https://vidfast.pro/tv/${showInfo.imdb}/${season.season_number}/${ep.episode_number}?autoPlay=true&autoNext=true`;
          
          iframePlayer.src = url;
          videoPlayer.classList.remove("hidden");
          document.body.style.overflow = "hidden";
        });

        epGrid.appendChild(epCard);
      });

      episodesContainer.appendChild(seasonSection);
    }
  })();
}
</script>
</body>
</html>
